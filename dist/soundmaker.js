(()=>{var B=class{constructor(){this.attack=0,this.sustain=0,this.decay=0,this.release=0,this.sustainLevel=0,this.id=""}updateParams(e){for(let t in e)t in this&&(this[t]=e[t])}applyADSR(e,t){let n=e.baseValue,o=this.sustainLevel===0?1:this.sustainLevel;return e.cancelAndHoldAtTime(t),e.linearRampToValueAtTime(0,t),e.linearRampToValueAtTime(n,t+this.attack),e.linearRampToValueAtTime(n*o,t+this.attack+this.decay),e.linearRampToValueAtTime(n*o,t+this.attack+this.decay+this.sustain),e}};function x(i,e,t=!1){let n=document.getElementById("svgCanvas");n===null&&(n=document.createElementNS("http://www.w3.org/2000/svg","svg"),n.style.position="absolute",n.id="svgCanvas:"+i.id+":"+e.id,n.style.zIndex="0",n.style.height="1000px",n.style.width="1000px",document.getElementById("nodeArea").appendChild(n));let o=document.createElementNS("http://www.w3.org/2000/svg","line");o!==null&&(o.classList.add("line"),o.setAttribute("stroke","#000"),o.setAttribute("stroke-width","1px")),t&&o.setAttribute("stroke-dasharray","10");let d=i.offsetLeft+document.body.scrollLeft+i.offsetWidth/2,E=i.offsetTop+document.body.scrollTop+i.offsetHeight/2,s=e.offsetLeft+document.body.scrollLeft+e.offsetWidth/2,a=e.offsetTop+document.body.scrollTop+e.offsetHeight/2;if(n!==null&&o!==null){o.setAttribute("x1",String(d)),o.setAttribute("y1",String(E)),o.setAttribute("x2",String(s)),o.setAttribute("y2",String(a));let p=Math.max(d,s)+200,r=Math.max(E,a)+200;n.style.height=parseInt(n.style.height)<r?r+"px":n.style.height,n.style.width=parseInt(n.style.width)<p?p+"px":n.style.width,n.appendChild(o)}}function D(i,e){let t=document.getElementById("editNode");if(t===null)return;for(t.style.display="block";t.firstChild;)t.removeChild(t.firstChild);let n=document.createElement("h3");n.textContent=i.node.id,t.appendChild(n);let o=i.node,d=Object.keys(Object.getPrototypeOf(i.node));d.length===0&&(d=Object.keys(i.node).filter(s=>typeof i.node[s]=="number")),d.forEach(s=>{let a=document.createElement("div");a.style.display="inline-block",a.style.marginRight="3%",a.style.marginLeft="3%";let p=document.createElement("p");a.appendChild(p);let r=s,y=!1;if(o[s].value!==void 0?(r+=".value",y=!0):typeof o[s]=="number"&&(y=!0),p.textContent=r,y){t.appendChild(a);let c=e[o.constructor.name]||e[o.type];c=c[s];let f=document.createElement("input");f.id=r,f.setAttribute("type","range"),f.setAttribute("max",c?c.max:.5),f.setAttribute("min",c?c.min:0),f.setAttribute("step",c?c.step:.01);let m=document.createElement("input");m.id=r+"-edit",m.setAttribute("size","6"),m.setAttribute("type","text"),o[s].value?f.setAttribute("value",o[s].baseValue):typeof o[s]=="number"?f.setAttribute("value",o[s]):f.setAttribute("value",c.default),m.value=f.getAttribute("value")||"",m.style.fontFamily="monospace",m.addEventListener("input",l=>{let u=parseFloat(l.target.value),g=f.getAttribute("min"),h=f.getAttribute("max");g&&h&&u>=parseFloat(g)&&u<=parseFloat(h)&&(f.setAttribute("value",u.toString()),o[s].value!==void 0?(o[s].value=u,o[s].baseValue=u):o[s]=u)}),f.addEventListener("input",function(l){let u=parseFloat(l.target.value);m.value=u.toString(),o[s].value!==void 0?(o[s].value=u,o[s].baseValue=u):o[s]=u}),a.appendChild(f),a.appendChild(m)}else if(s==="type"){t.appendChild(a);let c=document.createElement("select");c.id=r+"Type";let f=[];o.constructor.name.indexOf("Oscillator")>=0?f=e.waveType:f=e.filterType,f.forEach(m=>{let l=document.createElement("option");l.textContent=m,c.appendChild(l)}),c.addEventListener("change",m=>{let l=c.options[c.selectedIndex].value;i.node[s]=l}),c.value=o[s],a.appendChild(c)}});let E=document.createElement("p");E.style.margin="0 auto",E.style.marginTop="2%",E.style.width="3%",E.textContent="close",E.style.color="#ff0000",E.addEventListener("click",s=>{t.style.display="none"}),t.appendChild(E)}function O(i){let e=document.getElementById("importInstrumentPresetInput");e!==null&&(e.addEventListener("change",P(i),!1),e.click())}function k(i,e){e.reset();for(let t in i)if(t.indexOf("Gain")>-1?e.addNewNode("gainNode"):t.indexOf("Oscillator")>-1?e.addNewNode("waveNode"):t.indexOf("ADSR")>-1?e.addNewNode("ADSREnvelope"):t.indexOf("AudioBuffer")>-1?e.addNewNode("noiseNode"):t.indexOf("BiquadFilter")>-1&&e.addNewNode("biquadFilterNode"),t!=="AudioDestinationNode"){let n=e.nodeStore[t];n.feedsInto=i[t].feedsInto,n.feedsFrom=i[t].feedsFrom;let o=i[t].node;if("buffer"in o){if(o.buffer.channelData){let E=new Float32Array([...Object.values(o.buffer.channelData)]);delete o.buffer.duration;let s=new AudioBuffer(o.buffer);s.copyToChannel(E,0),o.buffer=s}let d=new AudioBufferSourceNode(e,o);d.loop=!0,d.id=t,n.node=d}else for(let d in o)n.node[d].value!==void 0?(n.node[d].value=o[d],n.node[d].baseValue=o[d]):d in n.node&&(n.node[d]=o[d])}for(let t in i)e.nodeStore[t].feedsInto.forEach(o=>{let d=document.getElementById(t);if(d!==null){let E=parseInt(d.style.top)+80,s=parseInt(d.style.top)-80;d.style.top=Math.random()*(E-s)+s+"px";let a=parseInt(d.style.left)+80,p=parseInt(d.style.left)-80;d.style.left=Math.random()*(a-p)+p+"px";let r=document.getElementById(o);document.getElementById("svgCanvas:"+t+":"+o)!==null&&r!==null&&(t.indexOf("ADSR")>-1?x(d,r,!0):x(d,r,!1))}})}function P(i){return function(e){return function(t){let n=new FileReader,o=t.target.files[0];n.onload=function(d){return function(E){let s=JSON.parse(n.result);s.data&&k(s.data,e)}}(o),n.readAsText(o)}}(i)}function R(i){let e=prompt("enter filename");if(e===null||e==="")return;let t={},n=i.nodeStore;Object.keys(n).forEach(p=>{let r=n[p],y={id:r.node.id,node:{},feedsFrom:r.feedsFrom,feedsInto:r.feedsInto},c=Object.keys(Object.getPrototypeOf(r.node));c.length===0&&(c=Object.keys(r.node));let f={};c.forEach(m=>{if(typeof r.node[m]=="object"&&"value"in r.node[m])f[m]=r.node[m].value;else if(r.node[m].constructor.name==="AudioBuffer"){let l=r.node[m],u={duration:l.duration,length:l.length,numberOfChannels:l.numberOfChannels,sampleRate:l.sampleRate,channelData:l.getChannelData(0)};f[m]=u}else f[m]=r.node[m]}),y.node=f,t[p]=y});let d={name:e,data:t},E=new Blob([JSON.stringify(d,null,2)],{type:"application/json"}),s=URL.createObjectURL(E),a=document.createElement("a");a.href=s,a.download=e+".json",a.click()}function M(i,e){fetch("demo-presets/"+i+".json").then(t=>t.json()).then(t=>{let n=t.data;k(n,e)})}var C=class extends AudioContext{constructor(){super();this.nodeColors={},this.nodeStore={},this.analyserNode=this.createAnalyser(),this.analyserNode.connect(this.destination),this.nodeCounts={addNode:function(e){let t=e.constructor.name;return this[t]?this[t]++:this[t]=1,this[t]},deleteNode:function(e,t=null){let n=e.constructor.name;return this[n]--,this[n]}},this.valueRanges={OscillatorNode:{detune:{min:-1200,default:0,max:1200,step:1},frequency:{min:300,default:440,max:1e3,step:1}},GainNode:{gain:{min:0,default:.3,max:2,step:.05}},AudioBufferSourceNode:{detune:{min:-1200,default:0,max:1200,step:1}},BiquadFilterNode:{gain:{max:40,min:-40,default:0,step:1},Q:{max:1e3,min:1e-4,default:1,step:.05},detune:{min:-1200,default:0,max:1200,step:1},frequency:{min:300,default:440,max:1e3,step:1}},ADSREnvelope:{attack:{min:0,default:0,max:1,step:.01},sustain:{min:0,default:0,max:1,step:.01},sustainLevel:{min:0,default:0,max:1,step:.01},decay:{min:0,default:0,max:1,step:.01},release:{min:0,default:0,max:10,step:.01}},waveType:["sine","square","triangle","sawtooth"],filterType:["lowpass","highpass","allpass","bandpass","notch","peaking","lowshelf","highshelf"]}}getGainNodes(){return[...Object.keys(this.nodeStore)].filter(e=>e.indexOf("Gain")>=0).map(e=>this.nodeStore[e])}getOscNodes(){return[...Object.keys(this.nodeStore)].filter(e=>e.indexOf("Oscillator")>=0||e.indexOf("AudioBuffer")>=0)}createAudioContextDestinationUI(e){let t=document.createElement("div");t.id=this.destination.constructor.name,t.style.border="1px solid #000",t.style.borderRadius="20px 20px 20px 20px",t.style.padding="5px",t.style.width="200px",t.style.height="200px",t.style.textAlign="center",t.style.position="absolute",t.style.top="20%",t.style.left="45%",t.style.zIndex="10";let n=document.createElement("h2");n.textContent="audio context destination",t.appendChild(n),e.appendChild(t)}reset(){let e=document.getElementById("nodeArea");if(e)for(let t in this.nodeStore)t!=="AudioDestinationNode"&&this._deleteNode(this.nodeStore[t].node,e)}_addBaseValueProp(e){for(let t in e)e[t]&&e[t].value&&(e[t].baseValue=e[t].value)}_storeNode(e,t){this.nodeStore[t]={node:e,feedsInto:[],feedsFrom:[]}}_createWaveNode(){let e=this.createOscillator();return e.frequency.value=440,e.detune.value=0,e.type="sine",e.id=e.constructor.name+this.nodeCounts.addNode(e),this._addBaseValueProp(e),e}_createNoiseNode(){let e=this.createBufferSource(),t=this.sampleRate,n=this.createBuffer(1,t,t),o=n.getChannelData(0);for(let d=0;d<t;d++)o[d]=Math.random()*2-1;return this._addBaseValueProp(e),e.buffer=n,e.loop=!0,e.id=e.constructor.name+this.nodeCounts.addNode(e),e}_createGainNode(){let e=this.createGain();return e.connect(this.analyserNode),e.gain.value=this.valueRanges.GainNode.gain.default,this._addBaseValueProp(e),e.id=e.constructor.name+this.nodeCounts.addNode(e),e}_createBiquadFilterNode(){let e=this.createBiquadFilter();return e.frequency.value=440,e.detune.value=0,e.gain.value=0,e.Q.value=1,e.type="lowpass",this._addBaseValueProp(e),e.id=e.constructor.name+this.nodeCounts.addNode(e),e}_createADSREnvelopeNode(){let e=new B;return e.id="ADSREnvelope"+this.nodeCounts.addNode(e),e}_deleteNode(e,t){let n=e.id,o=this.nodeStore[n].node;this.nodeCounts.deleteNode(e);let d=this.nodeStore[n].feedsInto;d&&d.forEach(a=>{let p=document.getElementById("svgCanvas:"+n+":"+a);p&&t.removeChild(p);let r=this.nodeStore[a].feedsFrom;this.nodeStore[a].feedsFrom=r.filter(y=>y!==n)});let E=this.nodeStore[n].feedsFrom;E&&E.forEach(a=>{let p=document.getElementById("svgCanvas:"+a+":"+n);p&&t.removeChild(p);let r=this.nodeStore[a].feedsInto;this.nodeStore[a].feedsInto=r.filter(y=>y!==n)}),delete this.nodeStore[n];let s=document.getElementById(n);s&&t.removeChild(s)}_addNodeToInterface(e,t,n="100px",o="100px"){let d=this._createNodeUIElement(e);d.style.top=n,d.style.left=o,t.appendChild(d)}_createNodeUIElement(e){let t=document.createElement("div");t.style.backgroundColor="#fff",t.style.zIndex="10",t.style.position="absolute",t.style.border="1px solid #000",t.style.borderRadius="20px 20px 20px 20px",t.style.padding="5px",t.style.textAlign="center",t.classList.add("nodeElement"),t.id=e.id;let n=this.nodeStore[e.id];t.addEventListener("mousedown",s=>{let a=s.clientX-t.offsetLeft+window.pageXOffset,p=s.clientY-t.offsetTop+window.pageYOffset;function r(c,f){t.style.left=c+"px",t.style.top=f+"px",n.feedsInto&&n.feedsInto.forEach(m=>{let l=document.getElementById("svgCanvas:"+t.id+":"+m);l!==null&&document.getElementById("nodeArea").removeChild(l);let u=document.getElementById(m);u!==null&&(t.id.indexOf("ADSR")>=0?x(t,u,!0):x(t,u))}),n.feedsFrom&&n.feedsFrom.forEach(m=>{let l=document.getElementById("svgCanvas:"+m+":"+t.id);l!==null&&document.getElementById("nodeArea").removeChild(l);let u=document.getElementById(m);u!==null&&(m.indexOf("ADSR")>=0?x(u,t,!0):x(u,t))})}function y(c){c.stopPropagation(),!!c.target.classList.contains("nodeElement")&&r(c.pageX-a,c.pageY-p)}document.addEventListener("mousemove",y),t.addEventListener("mouseup",c=>{document.removeEventListener("mousemove",y)})}),t.addEventListener("dblclick",s=>{D(n,this.valueRanges)});let o=document.createElement("h4");o.textContent=e.id,t.appendChild(o);let d=document.createElement("button");d.textContent="connect to another node",d.addEventListener("click",s=>{function a(l,u,g){let h=l.target;if(h&&!h.classList.contains("nodeElement")&&h.parentNode&&(h=h.parentNode),h&&!h.classList.contains("nodeElement")||g[h.id].node.numberOfInputs<1)return;h.style.backgroundColor="#fff",g[u.id].feedsInto.push(h.id),g[h.id].feedsFrom.push(u.id),u.id.indexOf("ADSR")>=0?x(u,h,!0):x(u,h),[...Object.keys(g)].forEach(I=>{if(I!==u.id){let S=document.getElementById(I);S!==null&&(S.removeEventListener("mouseover",y),S.removeEventListener("mouseleave",c),S.removeEventListener("click",r))}})}let p=this.nodeStore;function r(l){a(l,t,p)}function y(l){l.target.classList.contains("nodeElement")&&(l.target.style.backgroundColor="#ffcccc")}function c(l){l.target.classList.contains("nodeElement")&&(l.target.style.backgroundColor="#fff")}function f(l,u,g){l.preventDefault(),[...Object.keys(g)].forEach(h=>{if(h!==u.id){let b=document.getElementById(h);b!==null&&(b.removeEventListener("mouseover",y),b.removeEventListener("mouseleave",c),b.removeEventListener("click",r),b.style.backgroundColor="#fff")}}),document.body.removeEventListener("contextmenu",m)}function m(l){f(l,t,p)}document.body.addEventListener("contextmenu",m),[...Object.keys(p)].forEach(l=>{if(l!==t.id){let u=document.getElementById(l);u!==null&&(u.addEventListener("mouseover",y),u.addEventListener("mouseleave",c),u.addEventListener("click",r))}})}),t.appendChild(d),t.appendChild(document.createElement("br"));let E=document.createElement("button");return E.textContent="delete",E.addEventListener("click",s=>{let a=document.getElementById("nodeArea");a&&this._deleteNode(e,a)}),t.appendChild(E),t}addNewNode(e,t=!0){let n=null;if(e==="waveNode")n=this._createWaveNode();else if(e==="biquadFilterNode")n=this._createBiquadFilterNode();else if(e==="noiseNode")n=this._createNoiseNode();else if(e==="gainNode")n=this._createGainNode();else if(e==="ADSREnvelope")n=this._createADSREnvelopeNode();else{console.log("unknown node type!");return}this._storeNode(n,n.id);let o=document.getElementById("nodeArea");if(t&&o&&this._addNodeToInterface(n,o),e==="gainNode"){let d=this.destination.constructor.name;this.nodeStore[n.id].feedsInto=[d],this.nodeStore[d].feedsFrom.push(n.id);let E=document.getElementById(n.id),s=document.getElementById(d);E&&s&&x(E,s)}}};var q={C8:4186.01,B7:3951.07,Bb7:3729.31,"A#7":3729.31,A7:3520,Ab7:3322.44,"G#7":3322.44,G7:3135.96,Gb7:2959.96,"F#7":2959.96,F7:2793.83,E7:2637.02,Eb7:2489.02,"D#7":2489.02,D7:2349.32,Db7:2217.46,"C#7":2217.46,C7:2093,B6:1975.53,Bb6:1864.66,"A#6":1864.66,A6:1760,Ab6:1661.22,"G#6":1661.22,G6:1567.98,Gb6:1479.98,"F#6":1479.98,F6:1396.91,E6:1318.51,Eb6:1244.51,"D#6":1244.51,D6:1174.66,Db6:1108.73,"C#6":1108.73,C6:1046.5,B5:987.77,Bb5:932.33,"A#5":932.33,A5:880,Ab5:830.61,"G#5":830.61,G5:783.99,Gb5:739.99,"F#5":739.99,F5:698.46,E5:659.25,Eb5:622.25,"D#5":622.25,D5:587.33,Db5:554.37,"C#5":554.37,C5:523.25,B4:493.88,Bb4:466.16,"A#4":466.16,A4:440,Ab4:415.3,"G#4":415.3,G4:392,Gb4:369.99,"F#4":369.99,F4:349.23,E4:329.63,Eb4:311.13,"D#4":311.13,D4:293.66,Db4:277.18,"C#4":277.18,C4:261.63,B3:246.94,Bb3:233.08,"A#3":233.08,A3:220,Ab3:207.63,"G#3":207.63,G3:196,Gb3:185,"F#3":185,F3:174.61,E3:164.81,Eb3:155.56,"D#3":155.56,D3:146.83,Db3:138.59,"C#3":138.59,C3:130.81,B2:123.47,Bb2:116.54,"A#2":116.54,A2:110,Ab2:103.83,"G#2":103.83,G2:98,Gb2:92.5,"F#2":92.5,F2:87.31,E2:82.41,Eb2:77.78,"D#2":77.78,D2:73.42,Db2:69.3,"C#2":69.3,C2:65.41},G=class{constructor(){this.nodeFactory=new C,this.nodeFactory.suspend(),this.nodeFactory._storeNode(this.nodeFactory.destination,this.nodeFactory.destination.constructor.name)}};function _(i,e){let t=e.nodeStore,n=e.getOscNodes(),o=[];n.forEach(s=>{let a=t[s].node,p={};Object.keys(Object.getPrototypeOf(a)).forEach(c=>{let f=a[c];p[c]=f.value!==void 0?f.value:f,c==="frequency"&&(p[c]=i)});let r=new window[a.constructor.name](e,p);o.push(r),t[s].feedsInto.forEach(c=>{let f=t[c].node;if(r.connect(f),f.id.indexOf("Gain")<0){let m=t[f.id].feedsInto,l=f;for(;m.length>0;){let u=m.pop(),g=t[u].node;console.log("connecting: "+l.constructor.name+" to: "+g.constructor.name),l.connect(g),l=g;let h=t[u].feedsInto.filter(b=>b.indexOf("Destination")<0);m=m.concat(h)}}})});let d=e.currentTime;return e.getGainNodes().forEach(s=>{let a=s.node,p=H(s);p?t[p].node.applyADSR(a.gain,d):a.gain.setValueAtTime(a.gain.value,d)}),o}function H(i){let e=i.feedsFrom;for(let t=0;t<e.length;t++){let n=e[t];if(n.indexOf("ADSR")>=0)return n}return null}function j(){document.getElementById("addWavNode").addEventListener("click",i=>{N.nodeFactory.addNewNode("waveNode")}),document.getElementById("addGainNode").addEventListener("click",i=>{N.nodeFactory.addNewNode("gainNode")}),document.getElementById("addNoiseNode").addEventListener("click",i=>{N.nodeFactory.addNewNode("noiseNode")}),document.getElementById("addFilterNode").addEventListener("click",i=>{N.nodeFactory.addNewNode("biquadFilterNode")}),document.getElementById("addADSRNode").addEventListener("click",i=>{N.nodeFactory.addNewNode("ADSREnvelope")}),document.getElementById("download").addEventListener("click",i=>{R(N.nodeFactory)}),document.getElementById("import").addEventListener("click",i=>{O(N.nodeFactory)}),document.getElementById("demos").addEventListener("change",i=>{let e=i.target,t=e.options[e.selectedIndex].value;t!==""&&M(t,N.nodeFactory)}),document.getElementById("toggleViz").addEventListener("click",i=>{let e=i.target.style.border;!e||e==="3px solid rgb(0, 204, 0)"?(i.target.style.border="3px solid rgb(204, 0, 0)",i.target.textContent="off",window.cancelAnimationFrame(F),v.clearRect(0,0,A.width,A.height)):(i.target.style.border="3px solid rgb(0, 204, 0)",i.target.textContent="on",F=requestAnimationFrame(T))})}var N=new G,W=[...document.getElementsByClassName("note")],L=[];j();N.nodeFactory.createAudioContextDestinationUI(document.getElementById("nodeArea"));function z(i,e){let t=e;function n(o){o.target&&(o.target.style.stroke="#000000",o.target.style.strokeWidth="0.264583px");let d=t.currentTime;e.getGainNodes().forEach(s=>{let a=s.node,p=H(s);if(p){let r=e.nodeStore[p].node;a.gain.linearRampToValueAtTime(0,t.currentTime+r.release),d=Math.max(t.currentTime+r.release,d),a.gain.setValueAtTime(a.gain.baseValue,t.currentTime+r.release+.01)}else a.gain.setValueAtTime(a.gain.baseValue,t.currentTime)}),L.forEach(s=>{s.stop(d)})}i.forEach(o=>{o.addEventListener("mouseleave",n),o.addEventListener("mouseup",n),o.addEventListener("mousedown",d=>{d.buttons===1&&(d.target.style.stroke="#2470FC",d.target.style.strokeWidth="0.6px",t.resume().then(()=>{let E=q[o.id+document.getElementById("octaveSelect").value];L=_(E,e),L.forEach(s=>{s.start(0)})}))})})}z(W,N.nodeFactory);N.nodeFactory.analyserNode.fftSize=2048;var w=N.nodeFactory.analyserNode.frequencyBinCount,V=new Uint8Array(w),A=document.getElementById("vizCanvas"),v=A.getContext("2d");v.clearRect(0,0,A.width,A.height);var F=requestAnimationFrame(T);function T(){let i=A.width,e=A.height;if(v){N.nodeFactory.analyserNode.getByteTimeDomainData(V),v.fillStyle="rgb(200, 200, 200)",v.fillRect(0,0,i,e),v.lineWidth=2,v.strokeStyle="rgb(0, 0, 0)",v.beginPath();let t=i/w,n=0;for(let o=0;o<w;o++){let E=V[o]/128*(e/2);o===0?v.moveTo(n,E):v.lineTo(n,E),n+=t}v.stroke(),F=requestAnimationFrame(T)}}})();
//# sourceMappingURL=soundmaker.js.map
